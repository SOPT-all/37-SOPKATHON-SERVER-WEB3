name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        run: ./gradlew clean build -x test

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: collaboration-jar
          path: build/libs/*-SNAPSHOT.jar
          if-no-files-found: error

  deploy:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: collaboration-jar
          path: ./artifacts

      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USERNAME: ${{ secrets.EC2_USERNAME }}
          EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
        run: |
          # ë³€ìˆ˜ ì •ë¦¬ (ê³µë°±/ì¤„ë°”ê¿ˆ ì œê±°)
          export EC2_HOST=$(echo "$EC2_HOST" | xargs)
          export EC2_USERNAME=$(echo "$EC2_USERNAME" | xargs)

          # SSH í‚¤ ì„¤ì •
          echo "$EC2_SSH_KEY" > ec2_key.pem
          chmod 400 ec2_key.pem

          # JAR íŒŒì¼ EC2ë¡œ ì „ì†¡
          echo "ğŸ“¦ Deploying to ${EC2_USERNAME}@${EC2_HOST}"
          scp -i ec2_key.pem -o StrictHostKeyChecking=no \
            ./artifacts/*-SNAPSHOT.jar ${EC2_USERNAME}@${EC2_HOST}:~/37-SOPKATHON-SERVER-WEB3/build/libs/web3-0.0.1-SNAPSHOT.jar

          # ì• í”Œë¦¬ì¼€ì´ì…˜ ì¬ì‹œì‘
          echo "ğŸ”„ Restarting application..."
          ssh -i ec2_key.pem -o StrictHostKeyChecking=no ${EC2_USERNAME}@${EC2_HOST} << 'ENDSSH'
            cd ~/37-SOPKATHON-SERVER-WEB3

            # ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
            PID=$(pgrep -f 'java.*web3.*jar' || true)
            if [ -n "$PID" ]; then
              kill $PID
              sleep 3
            fi

            # ìƒˆ ë²„ì „ ì‹¤í–‰
            nohup java -jar build/libs/web3-0.0.1-SNAPSHOT.jar --spring.profiles.active=prod > app.log 2>&1 &

            # í—¬ìŠ¤ì²´í¬ (ìµœëŒ€ 30ì´ˆ ëŒ€ê¸°)
            echo "ğŸ” Health check..."
            for i in 1 2 3 4 5 6; do
              sleep 5
              if curl -s http://localhost:8080/actuator/health | grep -q '"status":"UP"'; then
                echo "âœ… Application is healthy!"
                exit 0
              fi
              echo "â³ Waiting... ($i/6)"
            done
            echo "âŒ Health check failed!"
            exit 1
          ENDSSH
